import requests
from bs4 import BeautifulSoup

# Get CSRF token
session = requests.Session()
create_report_url = "http://host.docker.internal:1337/reports/create"
csrf_token = None
try:
    response = session.get(create_report_url)
    response.raise_for_status()  # Raise an exception for bad status codes
    soup = BeautifulSoup(response.text, 'html.parser')
    csrf_token = soup.find('meta', {'name': 'csrf-token'})['content']
    print(f"CSRF Token: {csrf_token}")
except requests.exceptions.RequestException as e:
    print(f"Failed to get CSRF token: {e}")
except (TypeError, KeyError):
    print("CSRF token not found in the HTML.")

# Prepare the POST request
url = "http://host.docker.internal:1337/reports"
files = {'csv_file': open('dummy.csv', 'rb')}
data = {
    'title': 'test',
    'description': 'test',
    'sensitive_fields': "-i 's/old/new/g' file.txt",
    'chart_type': 'bar',
    'x_axis': 'name',
    'y_axis': 'age',
    '_token': csrf_token if csrf_token else ''
}

# Send the POST request
try:
    response = session.post(url, files=files, data=data)
    print(f"Status code: {response.status_code}")
    print(f"Response text: {response.text}")
except requests.exceptions.RequestException as e:
    print(f"Request failed: {e}")